/* -----------------------------------------------------------------------
 *  commentary‚Äëgenerator.js
 *  =======================
 *  ‚Ä¢  Parse la timeline JSON du PBA
 *  ‚Ä¢  Devine RBD / AST / TO / BLK quand ils n‚Äôexistent pas
 *  ‚Ä¢  G√©n√®re une phrase de commentaire riche en emoji
 *  -------------------------------------------------------------------- */

/* ---------- 1.  Dictionnaires (labels, emoji, templates) -------------- */

export const RESULT_LABEL = {
  made   : 'r√©ussi',
  success: 'r√©ussi',
  miss   : 'rat√©',
  fail   : 'rat√©',
  failure: 'rat√©',
  block  : 'contr√©'
};

export const ACTION_EMOJI = {
  '2PT' : 'üí•',
  '3PT' : 'üéØ',
  'RBD' : '‚úã',
  'AST' : '',
  'BLK' : 'üõë',
  'STL' : 'ü¶Ö',
  'TO'  : '‚ùå',
  'DD'  : 'üëè',
  'TD'  : 'üí™',
  'PASS': ''
};

export const COMMENT_TEMPLATES = {
  '2PT': {
    success: [
      '{emoji} BAM ! {player} transperce le filet √† 2‚ÄØpts‚ÄØ!',
      '{emoji} Joli jumper de {player} pour 2 points.',
      '{player} claque un dunk puissant ! {emoji} {emoji} ',
      '${player} d√©gaine √† mi-distance : c\'est dedans ! üî•',
      '{player} transperce le filet √† 2‚ÄØpts‚ÄØ!',
      'Joli jumper de {player} pour 2 points.',
      '{player} claque un dunk puissant ! üí•',
      '${player} d√©gaine √† mi-distance : c\'est dedans ! üî•',
      '{player} a enfin trouv√© le panier, miracle ! üôÑ'
    ],
    fail: [
      '{emoji} {player} manque son jumper √† 2‚ÄØpts.',
      '{player} d√©gaine √† mi‚ÄØ-distance‚ÄØ, mais √ßa ne rentre pas.',
      'Tentative de {player} qui ne trouve pas le fond du panier.',
      '{player} manque son jumper √† 2‚ÄØpts.',
      'Tentative de {player} qui ne trouve pas le fond du panier.',
      'Shoot CA TA STRO PHI QUE de {player} !',
      'Comment {player} a-t-il pu louper √ßa  ?! üò®',
      '{player} rate son layup... üòï',
      'Ce n\'est pas possible ! faut s\'entrainer l√† {player} !',
      'Loup√© de {player} ! Faut s\'entrainer !',
      'Le tir de {player} rebondit sur l\'arceau',
      'Airball de {player} ! üí®'
    ],
    block: [
      '{player} se fait contrer ! üñêÔ∏è',
      'Contre monstrueux sur {player} !',
      '{player} repouss√© au moment du tir !',
      '{player} voit son tir refus√© ! üõë',
      'La d√©fense dit non √† {player} !'
    ]
  },
  '3PT': {
    success: [
      '{emoji} BANG‚ÄØ! {player} au‚Äëdel√† de l‚Äôarc‚ÄØ!',
      '{emoji} Quel shoot √† 3‚ÄØpts de {player}‚ÄØ!',
      "BANG ! {player} pour 3 points et √ßa rentre! üí£",
      "Quel shoot √† 3 pts de {player} !",
      "{player} fait lever la salle √† 3 pts ! üôå",
      "Ficelle pure pour {player} ! üéØ",
      "{player} a ferm√© les yeux et √ßa rentre... quelle chance ! üçÄ"
    ],
    fail: [
      '{emoji} {player} trop court derri√®re l‚Äôarc.',
      '{player} de loin, mais √ßa ne rentre pas.',
      "{player} trop court derri√®re la ligne √† 3pts.",
      "{player} de loin, mais √ßa ne rentre pas",
      "La tentative lointaine de {player} ricoche",
      "{player} force son tir √† 3, sans succ√®s",
      "Rat√© ! il est temps que {player} d√©pense des $PAD !",
      'Le triple de {player} fait long feu'
    ],
    block: [
      '{emoji} {player} contr√© √† 3‚ÄØpts‚ÄØ!',
      '{emoji} Le tir longue distance de {player} est rejet√©‚ÄØ!',
      '{player} contr√© √† 3 pts ! üñêÔ∏è',
      'Le tir longue distance de {player} est rejet√© !',
      '{player} se fait √©teindre √† 3 pts !',
      'La main adverse sur le tir de {player} !',
      'Tentative √† 3 de {player} repouss√©e !'
    ]
  },
  'RBD': {
    neutral: [
      '{emoji} Rebond capt√© par {player}‚ÄØ!',
      '{player} s‚Äôimpose au rebond'
    ]
  },
   'BLK': {
    neutral: [
      '{emoji} Contre de {player}‚ÄØ!',
      '{player} dit ¬´‚ÄØnon, non, non‚ÄØ!‚ÄØ¬ª'
    ]
  },
  'STL': {
    neutral: [
      '{emoji} Interception de {player}‚ÄØ!',
      '{player} vole la balle‚ÄØ!'
    ]
  },
  'POS': {
    neutral: [
      'Belle passe de {from} vers {to}',
      '{from} ‚û°Ô∏è {to}',
      '{from} pour {to}',
      '{from} passe √† {to}',
      'üèÄ {from} vers {to} !',
      '{from} sert {to}',
      'Ballon de {from} √† {to} ‚ú®',
      '{from} trouve {to} !',
      'Passe de {from} pour {to}',
      '{from} distribue √† {to}'
    ]
  }
};

/* ---------------------- 2.  Utilitaires ------------------------------- */

const pick = arr => arr[Math.floor(Math.random() * arr.length)];

/** Devine s‚Äôil s‚Äôagit d‚Äôun tir √† 2 ou 3 points. */
function detectShotType(play) {
  // 1) colonne "3‚ÄëPoints" (format A4-3-Points, B1 3 Points, etc.)
  const threeKey = Object.keys(play).find(k =>
    k.toLowerCase().includes('3') && k.toLowerCase().includes('points') && +play[k] > 0
  );
  if (threeKey) return '3PT';

  // 2) Points == 3
  const ptsKey = Object.keys(play).find(k =>
    k.toLowerCase().endsWith('points') && +play[k] === 3
  );
  return ptsKey ? '3PT' : '2PT';
}

/* ----------------- 3.  Enrichissement de la timeline ------------------ */

/**
 * Ajoute actionType / actionResult aux lignes brutes + d√©duit RBD/AST/TO/BLK
 * @param {Array<Object>} rawPlays  Tableau JSON issu du fichier PBA
 * @returns {Array<Object>}         Tableau enrichi
 */
export function enrichPlays(rawPlays) {
  const plays = rawPlays.map(p => ({ ...p, actionType: null, actionResult: null }));

  for (let i = 0; i < plays.length; i++) {
    const cur  = plays[i];
    const prev = plays[i - 1] || {};
    const next = plays[i + 1] || {};

    const sit = (cur['commentaire-Situation'] || '').trim();
    const res = (cur['commentaire-Succes']    || '').trim().toLowerCase();

    // --- Nouveau : transformer Possession en PASS entre prev.Joueur ‚Üí cur.Joueur ---
    if (sit === 'Possession' && prev['commentaire-Joueur'] && cur['commentaire-Joueur']) {
      // V√©rifier que l'action pr√©c√©dente n'√©tait pas un tir et que les √©quipes sont les m√™mes
      const prevSit = (prev['commentaire-Situation'] || '').trim();
      if (prevSit !== 'Shoot' && prev['commentaire-Equipe'] === cur['commentaire-Equipe']) {
        cur.actionType   = 'POS';
        cur.actionResult = 'neutral';
        cur.fromPlayer = prev['commentaire-Joueur'];
        cur.toPlayer   = cur['commentaire-Joueur'];
        cur.fromTeam   = prev['commentaire-Equipe']; // Stocke l'√©quipe du passeur
        continue; // skip mapping POS
      }
    }

    /* --- Mapping direct ------------------------------------------------ */
    if (sit === 'Steal') {
      cur.actionType = 'STL';
      cur.actionResult = 'neutral';
    } else if (sit === 'Shoot') {
      cur.actionType = detectShotType(cur);
      cur.actionResult = res === 'succ√®s' ? 'success'
                        : res === 'blocked' ? 'block'
                        : 'fail';
    }

    /* --- R1¬†: Rebond --------------------------------------------------- */
    if (sit === 'Rebond Global' &&
        next?.['commentaire-Situation'] === 'Possession') {
      next.actionType   = 'RBD';
      next.actionResult = 'neutral';
    }

    /* --- R2¬†: Assist --------------------------------------------------- */
    if (sit === 'Shoot' && res === 'succ√®s' &&
        prev?.['commentaire-Situation'] === 'Possession' &&
        prev['commentaire-Equipe'] === cur['commentaire-Equipe'] &&
        prev['commentaire-Joueur'] !== cur['commentaire-Joueur']) {
      prev.actionType   = 'AST';
      prev.actionResult = 'neutral';
    }

    /* --- R3¬†: Turnover ------------------------------------------------- */
    if (sit === 'Possession' &&
        prev?.['commentaire-Situation'] === 'Possession' &&
        prev['commentaire-Equipe'] !== cur['commentaire-Equipe']) {
      prev.actionType   = 'TO';
      prev.actionResult = 'neutral';
    }

    /* --- R4¬†&¬†R5¬†: Shoot bloqu√© / ligne "Block" parasite -------------- */
    if (sit === 'Shoot' && res === 'blocked') {
      // Tir bloqu√© => rat√© + BLK √† premier joueur adverse apr√®s le tir
      cur.actionResult = 'block';
      const blocker = plays.slice(i + 1).find(p =>
        p['commentaire-Equipe'] &&
        p['commentaire-Equipe'] !== cur['commentaire-Equipe']
      );
      if (blocker) {
        blocker.actionType   = 'BLK';
        blocker.actionResult = 'neutral';
      }
    }
    if (sit === 'Block' &&
        prev?.['commentaire-Situation'] === 'Shoot' &&
        prev['commentaire-Joueur'] === cur['commentaire-Joueur']) {
      // On ignore cette ligne : d√©j√† trait√©e ci‚Äëdessus
      cur.actionType = null;
      cur.actionResult = null;
    }
  }
  return plays;
}

/* ---------------------- 4.  G√©n√©rateur final -------------------------- */

/**
 * Retourne une phrase de commentaire pr√™te √† l‚Äôaffichage
 * @param {Object} play  Ligne enrichie (doit contenir actionType / actionResult)
 * @returns {string}     Commentaire ou cha√Æne vide
 */
export function generateCommentary(play) {
  // DEBUG LOG
  console.log('[generateCommentary] play:', play);

  const { actionType, actionResult = 'neutral' } = play;
  if (!actionType) {
    console.warn('[generateCommentary] Pas de actionType:', play);
    return '';
  }

  const tplGroup = COMMENT_TEMPLATES[actionType];
  if (!tplGroup) {
    console.warn(`[generateCommentary] Pas de template pour actionType=${actionType}`, play);
    return '';
  }

  // result key¬†: success | fail | block | neutral
  const templates = tplGroup[actionResult] || tplGroup.neutral;
  if (!templates || !templates.length) {
    console.warn(`[generateCommentary] Pas de templates pour actionType=${actionType}, actionResult=${actionResult}`, play);
    return '';
  }

  const emoji = ACTION_EMOJI[actionType] || '';
  const player = play['commentaire-Joueur'] || '';
  const team   = play['commentaire-Equipe'] || '';

  let sentence = pick(templates);

  if (actionType === 'POS') {
    // Retrieve both player names and their teams if possible
    const from = play.fromPlayer || '';
    const to   = play.toPlayer   || '';
    const fromTeam = play.fromTeam || play['fromEquipe'] || '';
    const toTeam   = play.toTeam   || play['commentaire-Equipe'] || '';
    // Determine team class for each
    const fromClass = (fromTeam || '').toUpperCase() === 'A' ? 'team-a'
                     : (fromTeam || '').toUpperCase() === 'B' ? 'team-b'
                     : '';
    const toClass   = (toTeam || '').toUpperCase() === 'A' ? 'team-a'
                     : (toTeam || '').toUpperCase() === 'B' ? 'team-b'
                     : '';
    sentence = sentence
      .replace('{from}', `<span class=\"player ${fromClass}\">${from}</span>`)
      .replace('{to}', `<span class=\"player ${toClass}\">${to}</span>`);
  } else {
    // Determine team class for player
    let teamClass = '';
    if (team) {
      // Normalize team name to class (e.g., 'left', 'right', 'a', 'b')
      if (/left|gauche|a/i.test(team)) teamClass = 'team-a';
      else if (/right|droite|b/i.test(team)) teamClass = 'team-b';
      else teamClass = 'team-' + team.toLowerCase();
    }
    const playerSpan = `<span class=\"player ${teamClass}\">${player}</span>`;
    sentence = sentence
      .replace('{emoji}', emoji)
      .replace('{player}', playerSpan)
      .replace('{team}', team);
  }

  console.log(`[generateCommentary] actionType=${actionType}, actionResult=${actionResult}, sentence=`, sentence);
  return sentence;
}

/* ---------------------- 5.  Exports ¬´¬†namespace¬†¬ª --------------------- */

export const CommentaryGenerator = {
  enrichPlays,
  generateCommentary,
  pick,
  RESULT_LABEL,
  ACTION_EMOJI,
  COMMENT_TEMPLATES
};

/* ---------------------- 6.  Exemple d‚Äôutilisation ---------------------

import data from './Data-PBA.json'  assert { type: 'json' };
import { CommentaryGenerator as CG } from './commentary-generator.js';

const plays = CG.enrichPlays(data);

for (const p of plays) {
  const c = CG.generateCommentary(p);
  if (c) console.log(c);
}

------------------------------------------------------------------------ */

// Exposer le g√©n√©rateur comme variable globale pour compatibilit√©
window.CommentaryGenerator = CommentaryGenerator;
window.detectShotType = detectShotType; // Expose pour compatibilit√©
